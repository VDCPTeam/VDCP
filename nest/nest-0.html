<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <script type="text/javascript" src="../lib/d3-4.7.1/d3.min.js"></script>
    <script type="text/javascript" src="../node_modules/hammerjs/hammer.min.js"></script>
    <script type="text/javascript" src="../lib/jquery-3.3.1/jquery-3.1.1.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script type="text/javascript" src="../node_modules/materialize-css/bin/materialize.js"></script>
    <link rel="stylesheet" type="text/css" href="../node_modules/materialize-css/bin/materialize.css">
    <meta charset="UTF-8">
    <script type="text/javascript"
            src="../node_modules/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
    <title></title>
    <style type="text/css">
        body {
            background: gray;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row">
        <svg class="col s10 m10 l10 grey lighten-5 z-depth-5" id="svg-content" style="height: 800px">
        </svg>
        <div class="col s2 m2 l2 blue-grey lighten-5 z-depth-5 valign-wrapper" id="svg-control"
             style="height: 800px; z-index:-1">
            <a class="btn-floating btn-large waves-effect waves-light red" onclick="start()" id="StartButton"><i
                    class="material-icons">play_arrow</i></a>
            <a class="btn-floating btn-large waves-effect waves-light blue" onclick="replay()"><i
                    class="material-icons">replay</i></a>
        </div>

    </div>


</div>
<!--侧边栏-->
<ul id="slide-out" class="side-nav z-depth-5">
    <li>
        <div class="container"><img class="responsive-img" src="../img/logo.png" style="margin: 25px 0"></div>
    </li>
    <li>
        <div class="container">
            <div class="input-field">
                <select id="select-language" onchange="selected_lang()">
                    <option value="zh-cn" selected>简体中文</option>
                    <option value="en">English</option>
                </select>
            </div>
        </div>
    </li>
    <li>
        <div class="divider"></div>
    </li>
    <li>
        <div class="container"><span id="text-catalog"></span></div>
    </li>
    <li id="catalog">
        <!--侧边栏内部折叠目录-->
        <!--修改json-->
        <ul class="collapsible" data-collapsible="accordion"></ul>
    </li>
</ul>
<!--底部按钮-->
<div class="fixed-action-btn toolbar">
    <a class="btn-floating btn-large cyan">
        <i class="large material-icons">menu</i>
    </a>
    <ul>
        <li class="waves-effect waves-light"><a href="../index.html" class="tooltipped" id="text-tooltip-home"
                                                data-position="top" data-delay="50"><i
                class="material-icons">view_carousel</i></a></li>
        <li class="waves-effect waves-light"><a href="#!" class="tooltipped button-collapse" data-activates="slide-out"
                                                id="text-tooltip-sidenav" data-position="top" data-delay="50"><i
                class="material-icons">pageview</i></a></li>
        <li class="waves-effect waves-light"><a href="#info-modal" class="tooltipped" id="text-tooltip-info"
                                                data-position="top" data-delay="50"><i
                class="material-icons">info</i></a></li>
        <li class="waves-effect waves-light"><a href="#help-modal" class="tooltipped" id="text-tooltip-help"
                                                data-position="top" data-delay="50"><i
                class="material-icons">live_help</i></a></li>
    </ul>
</div>
<!--信息及帮助-->
<div id="info-modal" class="modal blue lighten-3">
    <div class="modal-content">
        <h4 id="text-modal-info"></h4>
        <div id="text-nest-0-info"></div>
    </div>
    <div class="modal-footer">
        <a href="#！" class=" modal-action modal-close waves-effect waves-green btn-flat text-next"></a>
    </div>
</div>
<div id="help-modal" class="modal orange lighten-3">
    <div class="modal-content">
        <h4 id="text-modal-help"></h4>
        <div id="text-nest-0-help"></div>
    </div>
    <div class="modal-footer">
        <a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat text-yes"></a>
    </div>
</div>
<!--注意：涉及页面文本的修改要到json里面改-->
<script type="text/javascript">
    /**
     * 控制侧边栏
     */
    $(".button-collapse").sideNav({
        draggable: true
    });
    var isopen = true;
    function switchnav() {
        if (isopen) {
            isopen = false;
            $(".button-collapse").sideNav("show");
        }
        else {
            isopen = true;
            $(".button-collapse").sideNav("hide");
        }
    }
    /**
     * 控制多语言及文本
     */
    var lang;
    var isinitial = true;
    var fib_0_intro;
    var next;
    $(document).ready(function () {
        $('select').material_select();
    });
    var txt = document.cookie.split(";");
    lang = $("#select-language").find("option:selected").val();
    var textjson;
    for (var i = 0; i < txt.length; i++) {
        if (txt[i].match("\{.*\}")) {
            lang = JSON.parse(txt[i]).lang;
        }
    }
    function catalog_id(sect, exam) {
        return "s" + sect + "e" + exam + "id";
    }
    function selected_lang() {
        if (!isinitial) {
            lang = $("#select-language").find("option:selected").val();
        } else isinitial = false;
        $.getJSON("../text/" + lang + ".json", function (data) {
            /**
             * 注意：
             * 每一个文本信息在json中储存后，
             * 都要在如下部分注册，
             * 先后顺序不产生影响。
             */
            $("#text-catalog").html(data.catalog);
            $("#text-tooltip-sidenav").attr("data-tooltip", data.tooltip_sidenav);
            $("#text-tooltip-help").attr("data-tooltip", data.tooltip_help);
            $("#text-tooltip-info").attr("data-tooltip", data.tooltip_info);
            $("#text-tooltip-home").attr("data-tooltip", data.tooltip_home);
            $(".text-yes").html(data.yes);
            $("#text-modal-info").html(data.modal_info);
            $("#text-modal-help").html(data.modal_help);
            $("#text-nest-0-info").html(data.nest_0_info);
            $("#text-nest-0-help").html(data.nest_0_help);
            $(".text-next").html(data.next);
            document.title = data.nest_0_title;
            /**
             * 到这里结束
             */
            $(document).ready(function () {
                $('.tooltipped').tooltip({delay: 50});
            });
        });
        $.getJSON("../catalog/" + lang + ".json", function (data) {
            $("#catalog .collapsible").remove();
            $("#catalog").append("<ul class='collapsible' data-collapsible='accordion'></ul>");
            var co_wrapper = $("#catalog .collapsible");
            for (var i = 0; i < data.length; i++) {
                var temp_li = co_wrapper.append("<li id='" + catalog_id(i, 0) + "'></li>");
                temp_li.find("#" + catalog_id(i, 0)).append("<div class='collapsible-header'><a class='waves-effect btn-flat' href='" + data[i].href + "'>" + data[i].text + "</a></div>");
                var temp_inner = temp_li.find("#" + catalog_id(i, 0)).append("<div class='collapsible-body'></div>");
                if (data[i].child != undefined) {
                    var temp_colle = temp_inner.find(".collapsible-body").append("<div class='collection'></div>");
                    for (var j = 0; j < data[i].child.length; j++) {
                        temp_colle.find(".collection").append("<a href='" + data[i].child[j].href + "' class='collection-item waves-effect btn-flat'>" + data[i].child[j].text + "</a>");
                    }
                }
            }
            $(document).ready(function () {
                $('.collapsible').collapsible();
            });
        });
        document.cookie = JSON.stringify({"lang": lang});
    }
    selected_lang();
    $(document).ready(function () {
        // the "href" attribute of .modal-trigger must specify the modal ID that wants to be triggered
        $('.modal').modal();
    });
</script>
<script>
    setTimeout(function () {
        $("#info-modal").modal('open');
    }, 100);
    setTimeout(function () {
        $("#info-modal").modal('close');
    }, 3000);
    setTimeout(function () {
        $("#help-modal").modal('open');
    }, 6000);

    setTimeout(function () {
        $.getJSON("../text/" + lang + ".json", function (data) {
            console.log(data.nest_0_toast);
            Materialize.toast(data.nest_0_toast, 5000);
        });
    }, 11000);
    setTimeout(function () {
        $.getJSON("../text/" + lang + ".json", function (data) {
            console.log(data.nest_0_toast_alert);
            Materialize.toast(data.nest_0_toast_alert[0] + BallNum + data.nest_0_toast_alert[1], 3000);
        });
    }, 7000);
    var color = ["#fffde7", "#fff9c4", "#fff59d", "#fbc02d", "#ffeb3b", "#fdd835", "#fbc02d"];
    var BoxNum = 5;
    //document.getElementById("num").value;
    var svg = d3.select("svg");
    var SWidth = 800;
    var SHeight = 800;
    var BallNum;
    var Box = new Array(BoxNum);
    var Ball = new Array();
    var circle;
    var rect;
    //容置
    function render() {
        BallNum = BoxNum + Math.floor(Math.random() * 3 + 1);
        for (var i = 0; i < BoxNum; i++)Box[i] = 0;
        for (var i = 0; i < BallNum; i++)Ball[i] = 1;
        circle = svg.selectAll("circle").data(Ball).enter()
            .append("circle")
            .attr("r", 0)
            .attr("cx", SWidth / 8)
            .attr("cy", SHeight / 4)
            .attr("fill", "#ffcc80")
            .attr("stroke", "#fb8c00")
            .attr("class", function (d, i) {
                return "circle_" + i;
            });
        setTimeout(function () {
                circle
                    .transition()
                    .ease(d3.easeLinear)
                    .duration(1000)
                    .attr("r", 25)
                    .transition()
                    .ease(d3.easeLinear)
                    .duration(1000)
                    .attr("cx", function (d, i) {
                        return SWidth / (BallNum * 2) + 100 * i;
                    })
                ;
            }
            , 4000);
        //容器
        rect = svg.selectAll("rect").data(Box).enter()
            .append("rect")
            .attr("x", function (d, i) {
                return SWidth / (BoxNum * 2) + 120 * i;
            })
            .attr("y", function (d, i) {
                return SHeight / 2;
            })
            .attr("width", 0)
            .attr("height", 0)
            .transition()
            .ease(d3.easeLinear)
            .duration(1000)
            .attr("width", function () {
                return 60;
            })
            .attr("height", function () {
                return 60;
            })
            .attr("fill", "white")
            .attr("stroke", "#ffd600")
            .attr("class", function (d, i) {
                return "rect_" + i;
            });
        svg.selectAll("circle")
            .call(d3.drag().on("drag", dragged)//.on("dragend",dragend)
            );
    }
    render();
    var CircleClass;


    svg.selectAll("rect").on("mouseover", function (d) {
        if (d3.select("circle." + CircleClass) != null) {
            var dx = Math.floor(d3.select(this).attr("x"));
            var dy = Math.floor(d3.select(this).attr("y"));
            var cx = Math.floor(d3.select("circle." + CircleClass).attr("cx"));
            var cy = Math.floor(d3.select("circle." + CircleClass).attr("cy"));
            var ClassNow = d3.select(this).attr("class");
            if (distance(dx, dy, cx, cy) < 100) {
                d3.select("circle." + CircleClass).remove();
                CircleClass = d3.selectAll("circle").attr("class");
                CircleSelect = 0;
                BallNum--;
                d++;
                if (d == 1) {
                    svg.append("text")
                        .attr("font-size", 40)
                        .attr("x", function (d, i) {
                            var x = Number(d3.select("rect." + ClassNow).attr("x"));
                            return x + 20;
                        })
                        .attr("y", function (d, i) {
                            var y = Number(d3.select("rect." + ClassNow).attr("y"));
                            return y + 40;
                        })
                        .attr("id", ClassNow)
                        .text(d);
                    console.log(d);
                    d3.select("rect." + ClassNow).attr("fill", function (d) {
                        return color[d];
                    });
                }
                else if (d > 1) {
                    svg.select("text#" + ClassNow).remove();
                    svg.append("text")
                        .attr("font-size", 40)
                        .attr("x", function (d, i) {
                            var x = Number(d3.select("rect." + ClassNow).attr("x"));
                            return x + 20;
                        })
                        .attr("y", function (d, i) {
                            var y = Number(d3.select("rect." + ClassNow).attr("y"));
                            return y + 40;
                        })
                        .attr("id", ClassNow)
                        .text(d);
                    console.log(d);
                    d3.select("rect." + ClassNow).attr("fill", function (d) {
                        return color[d];
                    });
                }//d3.select("circle.circle_"+i).remove();
            }
            else console.log("No circle");
        }
    });
    //距离
    function distance(x1, y1, x2, y2) {
        return Math.abs(Math.sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1)));
    }
    //拖拽   

    function dragged(d) {
        //d3.select("#StartButton").attr("class"," disabled");
        d3.select(this).attr("cx", d.x = d3.event.x).attr("cy", dy = d3.event.y);
        CircleClass = d3.select(this).attr("class");

    }


    //动画启动  
    function start() {
        var a = d3.rgb(227, 242, 253);
        var b = d3.rgb(13, 71, 161);
        var compute = d3.interpolate(a, b);
        circle
            .transition()
            .ease(d3.easeLinear)
            .duration(1000)
            .attr("cx", function () {
                var randomer = Math.floor(Math.random() * BoxNum);
                Box[randomer]++;
                return d3.select("rect.rect_" + randomer).attr("x");
            })
            .attr("cy", function () {
                return SHeight / 2;
            })
            .attr("r", 0)
            .remove();
        var k = 0
        setInterval(function () {
                if (k < BoxNum) {
                    svg.append("text")
                        .attr("font-size", 40)
                        .attr("x", function (d, i) {
                            var x = Number(d3.select("rect.rect_" + k).attr("x"));
                            return x + 20;
                        })
                        .attr("y", function (d, i) {
                            var y = Number(d3.select("rect.rect_" + k).attr("y"));
                            return y + 40;
                        })
                        .text(Box[k]);
                    d3.select("rect.rect_" + k).attr("fill", function () {
                        return color[Box[k]];
                    });
                    k++;
                }
                else window.clearInterval();
            }
            , 1000);
        Materialize.toast("必有一个或多个容器内有大于等于一个元素", 2000);
        setTimeout(function () {
            d3.selectAll("rect")
                .attr("stroke-width", 5)
                .attr("stroke", function (d, i) {
                    if (Box[i] >= 1)
                        return "#e64a19";
                })
            ;
        }, 6000)
        setTimeout(function () {
            d3.selectAll("rect")
                .attr("stroke", "#ffd600")
                .attr("stroke-width", 1);
        }, 7000)
    }
    function replay() {
        d3.selectAll("circle").remove();
        d3.selectAll("rect").remove();
        d3.selectAll("text").remove();
        render();
    }
</script>
</body>
<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <!--标题栏-->
    <title>template</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="../lib/jquery-3.3.1/jquery-3.1.1.min.js"></script>
    <script src="../lib/materialize-0.97.8/js/materialize.min.js"></script>
    <link rel="stylesheet" href="../lib/materialize-0.97.8/css/materialize.min.css"/>
    <script src="../lib/d3-4.7.1/d3.min.js"></script>
    <script src="../lib/MathJax/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
    <style type="text/css">
        body {
            background: gray;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row">
        <svg class="col s12 m10 l9 grey lighten-5 z-depth-5" id="svg-content" height="800px">
            <g id="expr">
                <rect x="200px" y="200px" height="80px" width="160px" stroke="#ff9800" fill="#ffcc80" rx="10px"
                      ry="10px" id="left"></rect>
                <text id="index1" x="380px" y="240px" font-size="16px"></text>
                <text x="210px" y="260px" font-size="40px" stroke="transparent" fill="transparent"
                      id="left-text"></text>
                <rect x="200px" y="300px" height="80px" width="160px" stroke="#ff9800" fill="#ffcc80" rx="10px"
                      ry="10px" id="right"></rect>
                <text id="index2" x="380px" y="340px" font-size="16px"></text>
                <text x="210px" y="360px" font-size="40px" stroke="transparent" fill="transparent"
                      id="right-text"></text>
                <text font-size="32px" x="160px" y="350px" stroke="#263238" fill="#263238">+</text>
                <line x1="140px" y1="400px" x2="420px" y2="400px" stroke-width="2" stroke="#263238"
                      fill="#263238"></line>
                <rect x="200px" y="420px" height="80px" width="160px" stroke="#ff9800" fill="#ffcc80" rx="10px"
                      ry="10px" id="result"></rect>
                <text id="index3" x="380px" y="460px" font-size="16px"></text>
                <text x="210px" y="480px" font-size="40px" stroke="transparent" fill="transparent"
                      id="result-text"></text>
            </g>
            <g id="choice">
                <g id="ch1">
                    <rect x="20px" y="600px" height="60px" width="160px" rx="5px" ry="5px" stroke="#cddc39"
                          fill="#e6ee9c"></rect>
                    <text x="30px" y="640px" font-size="40px" stroke="#827717" fill="#827717"></text>
                </g>
                <g id="ch2">
                    <rect x="200px" y="600px" height="60px" width="160px" rx="5px" ry="5px" stroke="#cddc39"
                          fill="#e6ee9c"></rect>
                    <text x="210px" y="640px" font-size="40px" stroke="#827717" fill="#827717"></text>
                </g>
                <g id="ch3">
                    <rect x="380px" y="600px" height="60px" width="160px" rx="5px" ry="5px" stroke="#cddc39"
                          fill="#e6ee9c"></rect>
                    <text x="390px" y="640px" font-size="40px" stroke="#827717" fill="#827717"></text>
                </g>
            </g>
        </svg>
        <div class="col s12 m2 l3 blue-grey lighten-5 z-depth-5" id="svg-control" style="height: 800px">
            <h5 class="center-align valign-wrapper section" id="fib2-sideinfo"></h5>
            <div class="divider"></div>
            <div class="section">
                <button class="center-align btn-large waves-effect large blue lighten-2" id="done"
                        onclick="next_expr()"><span
                        class="material-icons valign-wrapper">done</span>
                </button>
                <button class="center-align btn-large waves-effect large red lighten-2" id="replay" onclick="refresh()"><span
                        class="material-icons valign-wrapper">replay</span>
                </button>
            </div>
        </div>
    </div>
</div>
<!--侧边栏-->
<ul id="slide-out" class="side-nav z-depth-5">
    <li>
        <div class="container"><img class="responsive-img" src="../img/logo.png" style="margin: 25px 0"></div>
    </li>
    <li>
        <div class="container">
            <div class="input-field">
                <select id="select-language" onchange="selected_lang()">
                    <option value="zh-cn" selected>简体中文</option>
                    <option value="en">English</option>
                </select>
            </div>
        </div>
    </li>
    <li>
        <div class="divider"></div>
    </li>
    <li>
        <div class="container"><span id="text-catalog"></span></div>
    </li>
    <li id="catalog">
        <!--侧边栏内部折叠目录-->
        <!--修改json-->
        <ul class="collapsible" data-collapsible="accordion"></ul>
    </li>
</ul>
<!--底部按钮-->
<div class="fixed-action-btn toolbar">
    <a class="btn-floating btn-large cyan">
        <i class="large material-icons">menu</i>
    </a>
    <ul>
        <li class="waves-effect waves-light"><a href="#!" class="tooltipped button-collapse" data-activates="slide-out"
                                                id="text-tooltip-sidenav" data-position="top" data-delay="50"><i
                class="material-icons">pageview</i></a></li>
        <li class="waves-effect waves-light"><a href="#info-modal" class="tooltipped" id="text-tooltip-info"
                                                data-position="top" data-delay="50"><i
                class="material-icons">info</i></a></li>
        <li class="waves-effect waves-light"><a href="#help-modal" class="tooltipped" id="text-tooltip-help"
                                                data-position="top" data-delay="50"><i
                class="material-icons">live_help</i></a></li>
    </ul>
</div>
<!--信息及帮助-->
<div id="info-modal" class="modal blue lighten-3">
    <div class="modal-content">
        <h4 id="text-modal-info"></h4>
        <div id="text-fib-2-info"></div>
    </div>
    <div class="modal-footer">
        <button class=" modal-action modal-close waves-effect waves-green btn-flat text-yes"></button>
        <a href="fib-3.html" class="modal-action modal-close waves-effect waves-green btn-flat text-next"></a>
    </div>
</div>
<div id="help-modal" class="modal orange lighten-3">
    <div class="modal-content">
        <h4 id="text-modal-help"></h4>
        <div id="fib-2-help"></div>
    </div>
    <div class="modal-footer">
        <button class=" modal-action modal-close waves-effect waves-green btn-flat text-yes"></button>
    </div>
</div>
<!--注意：涉及页面文本的修改要到json里面改-->
<script type="text/javascript">
    /**
     * 控制侧边栏
     */
    $(".button-collapse").sideNav({
        draggable: true
    });
    var isopen = true;
    function switchnav() {
        if (isopen) {
            isopen = false;
            $(".button-collapse").sideNav("show");
        }
        else {
            isopen = true;
            $(".button-collapse").sideNav("hide");
        }
    }
    /**
     * 控制多语言及文本
     */
    var lang;
    var isinitial = true;
    $(document).ready(function () {
        $('select').material_select();
    });
    var txt = document.cookie.split(";");
    lang = $("#select-language").find("option:selected").val();
    for (var i = 0; i < txt.length; i++) {
        if (txt[i].match("\{.*\}")) {
            lang = JSON.parse(txt[i]).lang;
        }
    }
    function catalog_id(sect, exam) {
        return "s" + sect + "e" + exam + "id";
    }
    function selected_lang() {
        if (!isinitial) {
            lang = $("#select-language").find("option:selected").val();
        } else isinitial = false;
        $.getJSON("../text/" + lang + ".json", function (data) {
            /**
             * 注意：
             * 每一个文本信息在json中储存后，
             * 都要在如下部分注册，
             * 先后顺序不产生影响。
             */
            $("#text-catalog").html(data.catalog);
            $("#text-tooltip-sidenav").attr("data-tooltip", data.tooltip_sidenav);
            $("#text-tooltip-help").attr("data-tooltip", data.tooltip_help);
            $("#text-tooltip-info").attr("data-tooltip", data.tooltip_info);
            $(".text-yes").html(data.yes);
            $("#text-modal-info").html(data.modal_info);
            $("#text-modal-help").html(data.modal_help);
            $("#text-fib-2-info").html(data.fib_2_info);
            $("#fib-2-help").html(data.fib_2_help);
            $(".text-next").html(data.next);
            document.title = data.fib_2_title;
            /**
             * 到这里结束
             */
            $(document).ready(function () {
                $('.tooltipped').tooltip({delay: 50});
            });
        });
        $.getJSON("../catalog/" + lang + ".json", function (data) {
            $("#catalog .collapsible").remove();
            $("#catalog").append("<ul class='collapsible' data-collapsible='accordion'></ul>");
            var co_wrapper = $("#catalog .collapsible");
            for (var i = 0; i < data.length; i++) {
                var temp_li = co_wrapper.append("<li id='" + catalog_id(i, 0) + "'></li>");
                temp_li.find("#" + catalog_id(i, 0)).append("<div class='collapsible-header'><a class='waves-effect btn-flat' href='" + data[i].href + "'>" + data[i].text + "</a></div>");
                var temp_inner = temp_li.find("#" + catalog_id(i, 0)).append("<div class='collapsible-body'></div>");
                if (data[i].child != undefined) {
                    var temp_colle = temp_inner.find(".collapsible-body").append("<div class='collection'></div>");
                    for (var j = 0; j < data[i].child.length; j++) {
                        temp_colle.find(".collection").append("<a href='" + data[i].child[j].href + "' class='collection-item waves-effect btn-flat'>" + data[i].child[j].text + "</a>");
                    }
                }
            }
            $(document).ready(function () {
                $('.collapsible').collapsible();
            });
        });
        document.cookie = JSON.stringify({"lang": lang});
    }
    selected_lang();
    $(document).ready(function () {
        // the "href" attribute of .modal-trigger must specify the modal ID that wants to be triggered
        $('.modal').modal();
    });
    console.log(lang);
</script>
<!--开始本页内容-->
<script type="text/javascript">
    var expr_counter = 0;
    setTimeout(function () {
        $("#help-modal").modal("open");
    }, 100);
    setTimeout(function () {
        $("#info-modal").modal("close");
    }, 2000);
    /**
     * 拖拽交互
     */
    function sideinfo() {
        d3.json("../text/" + lang + ".json", function (e, g) {
            d3.select("#fib2-sideinfo").text(g.fib2_sideinfo[0] + (expr_counter + 1) + ", " + (expr_counter + 2) + ", " + (expr_counter + 3) + g.fib2_sideinfo[1]);
        });
    }
    function useable_done(b) {
        d3.select("#done").classed("disabled", !b);
        if (expr_counter > 9) {
            $("#info-modal").modal("open");
        }
    }
    function distance(x1, y1, x2, y2) {
        return Math.abs(Math.sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1)));
    }
    function refresh() {
        useable_done(false);
        for (var rf = 0; rf < 3; ++rf) {
            d3.select("g#ch" + (rf + 1)).select("rect").attr("x", (20 + rf * 180) + "px").attr("y", "600px");
            d3.select("g#ch" + (rf + 1)).select("text").attr("x", (30 + rf * 180) + "px").attr("y", "640px");
            d3.select("#index" + (rf + 1)).text("(" + (rf + expr_counter + 1) + ")");
        }
        d3.select("#left").attr("fill", "#ffcc80").attr("stroke", "#ff9800");
        d3.select("#left-text").text("").attr("fill", "transparent").attr("stroke", "transparent");
        d3.select("#right").attr("fill", "#ffcc80").attr("stroke", "#ff9800");
        d3.select("#right-text").text("").attr("fill", "transparent").attr("stroke", "transparent");
        d3.select("#result").attr("fill", "#ffcc80").attr("stroke", "#ff9800");
        d3.select("#result-text").text("").attr("fill", "transparent").attr("stroke", "transparent");
        d3.json("data/fib-2.json", function (e, g) {
            var posarr = [false, false, false];
            var leftdone = false, rightdone = false, resultdone = false;
            var finished = [false, false, false];
            while (!posarr[0] || !posarr[1] || !posarr[2]) {
                console.log(posarr);
                if (!leftdone) {
                    var i_l = Math.floor(Math.random() * 3);
                    if (!posarr[i_l]) {
                        d3.select("g#ch" + (i_l + 1)).select("rect").attr("fill", "#e6ee9c").attr("stroke", "#cddc39");
                        d3.select("g#ch" + (i_l + 1)).select("text").text(g[expr_counter].left).attr("fill", "#827717").attr("stroke", "#827717");
                        posarr[i_l] = true;
                        d3.select("g#ch" + (i_l + 1)).attr("data-bind", "left").call(d3.drag().on("start", function (d) {
                            console.log(d);
                        }).on("drag", function (d) {
                            d3.select("g#ch" + (i_l + 1)).select("rect").attr("x", d3.event.x).attr("y", d3.event.y);
                            d3.select("g#ch" + (i_l + 1)).select("text").attr("x", d3.event.x + 10).attr("y", d3.event.y + 40);
                        }).on("end", function (d) {
                            var tx = parseFloat(d3.select("#left").attr("x"));
                            var ty = parseFloat(d3.select("#left").attr("y"));
                            if (distance(d3.event.x, d3.event.y, tx, ty) < 50) {
                                d3.select("#left").attr("stroke", "#03a9f4").attr("fill", "#81d4fa");
                                d3.select("#left-text").attr("stroke", "#01579b").attr("fill", "#01579b").text(g[expr_counter].left);
                                d3.select("g#ch" + (i_l + 1)).select("rect").attr("fill", "transparent").attr("stroke", "transparent");
                                d3.select("g#ch" + (i_l + 1)).select("text").attr("fill", "transparent").attr("stroke", "transparent");
                                finished[i_l] = true;
                            }
                            if (finished[0] && finished[1] && finished[2]) {
                                useable_done(true);
                            }
                        }));
                        leftdone = true;
                    }
                }
                if (!rightdone) {
                    var i_ri = Math.floor(Math.random() * 3);
                    if (!posarr[i_ri]) {
                        d3.select("g#ch" + (i_ri + 1)).select("rect").attr("fill", "#e6ee9c").attr("stroke", "#cddc39");
                        d3.select("g#ch" + (i_ri + 1)).select("text").text(g[expr_counter].right).attr("fill", "#827717").attr("stroke", "#827717");
                        posarr[i_ri] = true;
                        d3.select("g#ch" + (i_ri + 1)).attr("data-bind", "right").call(d3.drag().on("start", function (d) {
                            console.log(d);
                        }).on("drag", function (d) {
                            d3.select("g#ch" + (i_ri + 1)).select("rect").attr("x", d3.event.x).attr("y", d3.event.y);
                            d3.select("g#ch" + (i_ri + 1)).select("text").attr("x", d3.event.x + 10).attr("y", d3.event.y + 40);
                        }).on("end", function (d) {
                            var tx = parseFloat(d3.select("#right").attr("x"));
                            var ty = parseFloat(d3.select("#right").attr("y"));
                            if (distance(d3.event.x, d3.event.y, tx, ty) < 50) {
                                d3.select("#right").attr("stroke", "#03a9f4").attr("fill", "#81d4fa");
                                d3.select("#right-text").attr("stroke", "#01579b").attr("fill", "#01579b").text(g[expr_counter].right);
                                d3.select("g#ch" + (i_ri + 1)).select("rect").attr("fill", "transparent").attr("stroke", "transparent");
                                d3.select("g#ch" + (i_ri + 1)).select("text").attr("fill", "transparent").attr("stroke", "transparent");
                                finished[i_ri] = true;
                            }
                            if (finished[0] && finished[1] && finished[2]) {
                                useable_done(true);
                            }
                        }));
                        rightdone = true;
                    }
                }
                if (!resultdone) {
                    var i_re = Math.floor(Math.random() * 3);
                    if (!posarr[i_re]) {
                        d3.select("g#ch" + (i_re + 1)).select("rect").attr("fill", "#e6ee9c").attr("stroke", "#cddc39");
                        d3.select("g#ch" + (i_re + 1)).select("text").text(g[expr_counter].result).attr("fill", "#827717").attr("stroke", "#827717");
                        posarr[i_re] = true;
                        d3.select("g#ch" + (i_re + 1)).attr("data-bind", "right").call(d3.drag().on("start", function (d) {
                            console.log(d);
                        }).on("drag", function (d) {
                            d3.select("g#ch" + (i_re + 1)).select("rect").attr("x", d3.event.x).attr("y", d3.event.y);
                            d3.select("g#ch" + (i_re + 1)).select("text").attr("x", d3.event.x + 10).attr("y", d3.event.y + 40);
                        }).on("end", function (d) {
                            var tx = parseFloat(d3.select("#result").attr("x"));
                            var ty = parseFloat(d3.select("#result").attr("y"));
                            if (distance(d3.event.x, d3.event.y, tx, ty) < 50) {
                                d3.select("#result").attr("stroke", "#03a9f4").attr("fill", "#81d4fa");
                                d3.select("#result-text").attr("stroke", "#01579b").attr("fill", "#01579b").text(g[expr_counter].result);
                                d3.select("g#ch" + (i_re + 1)).select("rect").attr("fill", "transparent").attr("stroke", "transparent");
                                d3.select("g#ch" + (i_re + 1)).select("text").attr("fill", "transparent").attr("stroke", "transparent");
                                finished[i_re] = true;
                            }
                            if (finished[0] && finished[1] && finished[2]) {
                                useable_done(true);
                            }
                        }));
                        resultdone = true;
                    }
                }
            }
        });
    }
    function next_expr() {
        expr_counter++;
        useable_done(false);
        sideinfo();
        refresh();
    }
    sideinfo();
    useable_done(false);
    refresh();
    /**
     * 力布局展示数列
     */
</script>
</body>
</html>